# DIP-Fantasy

BIT数字图像处理大作业。试图运用大三上所学的所有新技术来完成。

## 文档

实验过程文档全部在`doc`文件夹下，包括项目的配置，以及`CMake`、`OpenCV`等的使用。

## 项目结构

项目的`tree`:

```shell
.
├── build
├── doc
├── input
│   └── DataSet
├── judge
├── lib
│   └── debug
└── 课堂内容实现
    └── practice_Image
```

- `/build`为放置CMake临时文件的目录，并不重要。一个众所周知的用法是：

  ```shell
  cd ./build
  cmake ..
  ```

- `/doc`放置了本项目的所有文档，同时也包括OpenCV以及其他开发相关的软件（如CMake）的使用
- `/input`现已置空，因为老师给的训练集中的图片较多，体积比较大，因此将其全部存放在了本地而不是上传到Github
- `/judge`部分放了评测机。如何使用评测请看后文
- `/lib`文件夹即为`DipFantasy.h`和其对应的源文件的代码，也就是本项目所试图构建的图形库。根目录的`Main.cpp`即通过调用这个库完成流程
- `/课堂内容实现`为练手部分，通过调用OpenCV实现了课堂中所要求的部分

## 编译方法

```shell
cmake .
make
```

如果要清除编译后的缓存，使用vscode的任务clean即可。

### Debug

模块Debug：在`/lib`下有一个`/lib/debug`文件，里面装了单独编译`lib/DipFantasy.cpp`的`CMake`文件。将`DipFantasy.cpp`的main注释解除，再将vscode的调试选项设置为`module debug`就能单独调试库函数（直接在`ib/DipFantasy.cpp`中调试）。

## 流程

滤波平滑->阈值->sobel/canny 总之要把车道线转换为单独的像素->霍夫变换->得到对应检测的线的参数
![image-20210201213204319](https://cdn.jsdelivr.net/gh/I-Rinka/picTure//image-20210201213204319.png)

## 评测机

评测机为`lane.py`，来自 <https://github.com/TuSimple/tusimple-benchmark> 中的车道线评测机`lane.py`

将**对应格式**的评测结果输出成`./predict.json`后，在shell中输入命令就能进行跑分：

```shell
python3 ./judge.py ./predict.json ./groundtruth.json
```

注意，上面所说的`predict.json`的格式比原来要多加一项`"run_time":`属性以表示处理每一帧所用的时间。因为我们的评测只有一帧图片，并且运行时间对我们来说无关紧要，所以设置为`0`即可。上述格式输出的`predict.json`文件中的每一行的格式应该和这个类似（注意多添加一个`"run_time"=0`）：

```json
{"lanes": [[-2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, 610, 600, 590, 580, 570, 560, 550, 540, 530, 520, 510, 500, 490, 480, 470, 460, 450, 440, 430, 420, 410, 400, 390, 380, 370, 360, 350, 340, 330, 320, 310, 300, 290, 280, 270, 260, 250, 240, 230, 220, 210, 200, 190, 180, -2], [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, 686, 699, 711, 724, 736, 748, 761, 773, 786, 798, 810, 823, 835, 848, 860, 872, 885, 897, 909, 922, 934, 947, 959, 971, 984, 996, 1009, 1021, 1033, 1046, 1058, 1071, 1083, 1095, 1108, 1120, 1133, 1145, 1157, 1170, 1182, 1195, 1207, 1219, 1232], [-2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, 755, 794, 832, 869, 904, 938, 973, 1007, 1042, 1076, 1111, 1145, 1180, 1214, 1249, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2]], "h_samples": [160, 170, 180, 190, 200, 210, 220, 230, 240, 250, 260, 270, 280, 290, 300, 310, 320, 330, 340, 350, 360, 370, 380, 390, 400, 410, 420, 430, 440, 450, 460, 470, 480, 490, 500, 510, 520, 530, 540, 550, 560, 570, 580, 590, 600, 610, 620, 630, 640, 650, 660, 670, 680, 690, 700, 710],"raw_file": "clips/0530/1492626409999627292_0/20.jpg","run_time":0}
```

这个评测使用的是线性回归，并且测试的是相似性，因此并不要求输出结果完全点对点。即使参数上有一点小波动，甚至是少检测出一根线，都不会有非常非常大的影响。

由于评测机是python2的格式，和python3不兼容，为了方便，我将文件中的`print`改为了python3的`print()`格式，其余部分未进行改动

## 进度

- [x] 预处理
  - [x] 图像读入
  - [x] 高斯滤波
  - [x] 颜色切割
  - [x] 直方图均衡（彩色，三通道）
- [x] 梯度运算
  - [x] sobel
  - [ ] sobel单线化（舍弃右边，只要左边）
- [x] 后处理
  - [x] 乘法（图像屏蔽）
  - [x] 加法（构造mask）
  - [ ] 形态学运算
- [x] 霍夫变换
- [x] 直线筛选

整体流程：

- [x] 造库
- [ ] 编程
- [x] 评测机研究
- [ ] 实验报告

希望弄懂的：

- [ ] Cpp向上、向下造型
